## 4.4. Tokens|令牌

* [4.4.1. Supported Tokens](4.4.1. Supported Tokens 支持的令牌.md)
* [4.4.2. Supported Tokentypes](4.4.2. Supported Tokentypes 支持的令牌类型.md)
* [4.4.3. Token configuration](4.4.3. Token configuration 令牌配置.md)













#### 4.4.3.6. U2F Token Config

##### 4.4.3.6.1. AppId

You need to configure the AppId of the privacyIDEA server. The AppId is define in the FIDO specification <span id="id3">[[1]](#fido)</span>.

The AppId is the URL of your privacyIDEA and used to find or create the right key pair on the U2F device. The AppId must correspond the the URL that is used to call the privacyIDEA server.

> Note:
> 
> if you register a U2F device with an AppId https://privacyidea.example.com and try to authenticate at https://10.0.0.1, the U2F authentication will fail.
> 
> Note:
> 
> The AppId must not contain any trailing slashes!

##### 4.4.3.6.2. Facets

If specifying the AppId as the FQDN you will only be able to authenticate at the privacyIDEA server itself or at any application in a sub directory on the privacyIDEA server. This is OK, if you are running a SAML IdP on the same server.

But if you also want to use the U2F token with other applications, you need to specify the AppId like this:

https://privacyidea.example.com/pi-url/ttype/u2f

pi-url is the path, if you are running the privacyIDEA instance in a sub folder.

/ttype/u2f is the endpoint that returns a trusted facets list. Trusted facets are other hosts in the domain example.com. You need to define a policy that contains a list of the other hosts (u2f_facets).

For more information on AppId and trusted facets see <span id="id4">[[1]](#fido)</span>.

For further details and for information how to add U2F to your application you can see the code documentation at U2F Token.

##### 4.4.3.6.3. Workflow

You can use a U2F token on privacyIDEA and other hosts in the same Domain. To do so you need to do the following steps:

1. Configure the AppId to reflect your privacyIDEA server:  
https://pi.your-network.com/ttype/u2f  
Add the path /ttype/u2f is crucial. Otherwise privacyIDEA will not return the trusted facets.
2. Define a policy with the list of trusted facets. (see u2f_facets). Add the FQDNs of the hosts to the policy:  
saml.your-network.com otherapp.your-network.com vpn.your-network.com  
> Note:
> 
> The privacyIDEA plugin for simpleSAMLphp supports U2F with privacyIDEA starting with version 2.8.
3. Now register a U2F token on https://pi.your-network.com. Due to the trusted facets you will also be able to use this U2F token on the other hosts.
4.Now got to https://saml.your-network.com and you will be able to authenticate with the very U2F token without any further registering.

**Footnotes**

> [1] ([1](#id3), [2](#id4)): https://fidoalliance.org/specs/fido-u2f-v1.0-nfc-bt-amendment-20150514/fido-appid-and-facets.html<span id="fido"></span>

#### 4.4.3.7. Yubico Cloud mode

The Yubico Cloud mode sends the One Time Password emitted by the yubikey to the Yubico Cloud service or another (possibly self hosted) validation server.

![yubico](yubico.png)

Configure the Yubico Cloud mode

To contact the Yubico Cloud service you need to get an API key and a Client ID from Yubico and enter these here in the config dialog. In that case you can leave the Yubico URL blank and privacyidea will use the Yubico servers.

You can use another validation host, e.g. a self hosted validation server. If you use privacyidea token type yubikey, you can use the URL https://<privacyideaserver>/ttype/yubikey, other validation servers might use https://<validationserver>/wsapi/2.0/verify. You’ll get the Client ID and API key from the configuration of your validation server.

You can get your own API key at <span id="id5>[[1]](#yubico)</span>.

> [[1]](#id5): https://upgrade.yubico.com/getapikey/<span id="yubico"></span>

#### 4.4.3.8. Yubikey AES mode

The Yubico AES mode uses the same kind of token as the Yubico Cloud service, but validates the OTP in your local privacyidea server. So the secrets stay local to your system and are not stored in Yubico’s Cloud service.

![yubikey](yubikey.png)

Configure the Yubikey AES mode

You can have more than one Client with a Client ID connect to your server. The Client ID starts with yubikey.apiid. and is followed by the API ID, which you’ll need to configure your clients. With create new API key you generate a new API for that specific Client ID. The API key is used to sign the validation request sent to the server and the server signs the answer too. That way tampering or MITM attacks might be detected. It is possible to validate token without the API key, but then the request and answer can’t be verify against the key. It is useful to use HTTPS for your validation requests, but this is another kind of protection.

OTP validation can either use the privacyidea API /validate/check or the Yubikey validation protocol /ttype/yubikey or - if enabled in your webserver configuration - /wsapi/2.0/verify.
